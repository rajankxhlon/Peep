<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reply to Peep</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .header {
            background-color: #1da1f2;
            color: white;
            padding: 12px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
        }

        .header .page-title {
            font-size: 17px;
            font-weight: bold;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
            width: 100%;
        }

        .original-tweet-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
            box-sizing: border-box;
            border-left: 3px solid #1da1f2; /* Highlight original tweet */
        }

        .original-tweet-card .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .profile-pic-container {
            width: 30px; /* Smaller for original tweet context */
            height: 30px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ddd;
            color: #555;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .profile-pic-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Updated: Username color to grey for both original tweet and replies */
        .original-tweet-card .username,
        .reply-card .username {
            font-weight: bold;
            color: #657786; /* Grey color for usernames */
            font-size: 14px;
            margin-right: 5px;
        }

        .verified-tick {
            width: 15px;
            height: 15px;
            vertical-align: middle;
        }

        .original-tweet-card .tweet-content {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
            margin-top: 5px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        .original-tweet-card .tweet-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .original-tweet-card .tweet-link {
            font-size: 0.85em;
            color: #1da1f2;
            word-break: break-all;
            margin-top: 5px;
        }

        .reply-composer {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
            margin-bottom: 20px; /* Space between composer and replies */
        }

        .reply-composer textarea {
            width: calc(100% - 20px);
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .composer-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .reply-composer button#reply-btn {
            background-color: #1da1f2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }

        .reply-composer button#reply-btn:hover {
            background-color: #0d8ddb;
        }

        #loading-message, #error-message, #replies-loading {
            text-align: center;
            color: #66757f;
            margin-top: 20px;
        }

        #error-message {
            color: red;
        }

        .replies-section {
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
            margin-top: 20px;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .replies-section h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .reply-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            word-wrap: break-word;
            position: relative;
        }

        .reply-card .reply-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .reply-card .timestamp {
            color: #66757f;
            font-size: 11px;
            position: absolute;
            bottom: 10px;
            right: 15px;
        }

        .reply-card .reply-content {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
            margin-bottom: 15px; /* Space above timestamp */
        }

        .no-replies-message {
            text-align: center;
            color: #66757f;
            margin-top: 10px;
        }

        /* NEW CSS for Reply Button, Like Button, and Three Dots */
        .reply-actions {
            display: flex;
            align-items: center;
            gap: 15px; /* Space between items */
            margin-top: 10px; /* Space below content */
            padding-top: 5px; /* Padding above actions */
            border-top: 1px solid #eee; /* Separator */
            width: 100%;
        }

        .reply-actions .action-button {
            background-color: #e0e0e0;
            color: #333;
            padding: 5px 10px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reply-actions .action-button:hover {
            background-color: #d0d0d0;
        }

        .reply-actions .like-button {
            color: #66757f; /* Default grey */
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none; /* Prevent text selection */
        }

        .reply-actions .like-button .fas.fa-heart {
            color: #e0245e; /* Red for liked */
        }

        .reply-actions .like-count {
            font-size: 13px;
            color: #66757f;
        }

        .reply-options-menu {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: #66757f;
        }

        .reply-dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 5px;
            right: 0;
            top: 25px; /* Position below the three dots */
        }

        .reply-dropdown-content button {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .reply-dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .reply-dropdown-content button:first-child {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .reply-dropdown-content button:last-child {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .reply-card .edit-textarea {
            width: calc(100% - 20px);
            min-height: 60px;
            padding: 8px;
            border: 1px solid #1da1f2;
            border-radius: 5px;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .reply-card .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 5px;
        }

        .reply-card .edit-buttons button {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }

        .reply-card .edit-buttons .save-btn {
            background-color: #1da1f2;
            color: white;
            border: none;
        }

        .reply-card .edit-buttons .cancel-btn {
            background-color: #ccc;
            color: #333;
            border: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <span class="page-title">Reply to Peep</span>
    </header>

    <div class="main-content">
        <div id="loading-message">Loading original peep...</div>
        <div id="error-message" style="display: none;"></div>

        <div id="original-tweet-container" class="original-tweet-card" style="display: none;">
            <div class="tweet-header">
                <div class="profile-pic-container">
                    <img id="original-tweet-profile-pic" src="" alt="Profile Pic" style="display: none;">
                    <span id="original-tweet-profile-letter"></span>
                </div>
                <span class="username" id="original-tweet-username"></span>
                </div>
            <p class="tweet-content" id="original-tweet-content"></p>
            <img class="tweet-image" id="original-tweet-image" src="" alt="Tweet image" style="display: none;">
            <a class="tweet-link" id="original-tweet-link" href="#" target="_blank" rel="noopener noreferrer" style="display: none;"></a>
        </div>

        <div class="reply-composer">
            <textarea id="reply-input" placeholder="Peep your reply!"></textarea>
            <div class="composer-footer">
                <button id="reply-btn">Reply</button>
            </div>
        </div>

        <div class="replies-section">
            <h2>Replies</h2>
            <div id="replies-loading">Loading replies...</div>
            <div id="replies-feed">
                <p class="no-replies-message" id="no-replies-message" style="display: none;">No replies yet. Be the first to reply!</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase configuration (same as home.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBh9gNTXJYgcvt4vuiV5U0UqSeFhH8afcA",
            authDomain: "yellowchat-ad31a.firebaseapp.com",
            databaseURL: "https://yellowchat-ad31a-default-rtdb.firebaseio.com",
            projectId: "yellowchat-ad31a",
            storageBucket: "yellowchat-ad31a.firebasestorage.app",
            messagingSenderId: "592543476537",
            appId: "1:592543476537:web:10a2102227c06ac0d756e8",
            measurementId: "G-2BZFXPKCHD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Elements
        const originalTweetContainer = document.getElementById('original-tweet-container');
        const originalTweetUsername = document.getElementById('original-tweet-username');
        const originalTweetContent = document.getElementById('original-tweet-content');
        const originalTweetImage = document.getElementById('original-tweet-image');
        const originalTweetLink = document.getElementById('original-tweet-link');
        const originalTweetProfilePic = document.getElementById('original-tweet-profile-pic');
        const originalTweetProfileLetter = document.getElementById('original-tweet-profile-letter');

        const replyInput = document.getElementById('reply-input');
        const replyBtn = document.getElementById('reply-btn');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');

        const repliesSection = document.querySelector('.replies-section');
        const repliesFeed = document.getElementById('replies-feed');
        const repliesLoading = document.getElementById('replies-loading');
        const noRepliesMessage = document.getElementById('no-replies-message');

        let currentUsername = null;
        let currentUserId = null;
        let currentIsVerified = false;
        let tweetIdToReply = null; // Store the ID of the tweet being replied to

        // Helper function to format timestamp (re-used from home.html)
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate(); // Convert Firestore Timestamp to Date object
            const now = new Date();
            const diffMs = now - date; // Difference in milliseconds

            const seconds = Math.floor(diffMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return `${seconds}s ago`;
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;

            const options = { month: 'short', day: 'numeric' };
            if (date.getFullYear() !== now.getFullYear()) {
                options.year = 'numeric';
            }
            return date.toLocaleDateString(undefined, options);
        }

        // Function to extract tweetId from URL
        function getTweetIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('tweetId');
        }

        // Function to create the verified tick SVG element (UPDATED with new SVG)
        function createVerifiedTickSvg() {
            const svgString = `<svg class="verified-tick" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
	<polygon points="45,6.18 57.06,0 64.41,11.38 77.94,12.06 78.62,25.59 90,32.94 83.82,45 90,57.06 78.62,64.41 77.94,77.94 64.41,78.62 57.06,90 45,83.82 32.94,90 25.59,78.62 12.06,77.94 11.38,64.41 0,57.06 6.18,45 0,32.94 11.38,25.59 12.06,12.06 25.59,11.38 32.94,0 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,150,241); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
	<polygon points="40.16,58.47 26.24,45.08 29.7,41.48 40.15,51.52 61.22,31.08 64.7,34.67 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
</g>
</svg>`;
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
            return svgDoc.documentElement;
        }

        // Function to fetch and display the original tweet
        async function fetchOriginalTweet(tweetId) {
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            originalTweetContainer.style.display = 'none';

            try {
                const tweetDoc = await db.collection('tweets').doc(tweetId).get();
                if (tweetDoc.exists) {
                    const tweetData = tweetDoc.data();
                    originalTweetUsername.textContent = tweetData.username;
                    originalTweetContent.textContent = tweetData.content;

                    // Clear previous verified tick if any
                    const existingTick = originalTweetUsername.nextElementSibling;
                    if (existingTick && existingTick.classList.contains('verified-tick')) {
                        existingTick.remove();
                    }

                    if (tweetData.isVerified) {
                        originalTweetUsername.after(createVerifiedTickSvg());
                    }

                    // Handle image
                    if (tweetData.imageUrl) {
                        originalTweetImage.src = tweetData.imageUrl;
                        originalTweetImage.style.display = 'block';
                    } else {
                        originalTweetImage.style.display = 'none';
                    }

                    // Handle link
                    if (tweetData.linkUrl) {
                        originalTweetLink.href = tweetData.linkUrl;
                        originalTweetLink.textContent = tweetData.linkUrl;
                        originalTweetLink.style.display = 'block';
                    } else {
                        originalTweetLink.style.display = 'none';
                    }

                    // Handle profile picture/letter
                    const userDoc = await db.collection('users').doc(tweetData.userId).get();
                    if (userDoc.exists && userDoc.data().profilePictureUrl) {
                        originalTweetProfilePic.src = userDoc.data().profilePictureUrl;
                        originalTweetProfilePic.style.display = 'block';
                        originalTweetProfileLetter.style.display = 'none';
                    } else {
                        originalTweetProfileLetter.textContent = tweetData.username ? tweetData.username.charAt(0).toUpperCase() : '?';
                        originalTweetProfileLetter.style.display = 'block';
                        originalTweetProfilePic.style.display = 'none';
                    }

                    originalTweetContainer.style.display = 'block';
                    loadingMessage.style.display = 'none';
                } else {
                    errorMessage.textContent = 'Original peep not found.';
                    errorMessage.style.display = 'block';
                    loadingMessage.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching original tweet:", error);
                errorMessage.textContent = 'Error loading original peep. Please try again.';
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
            }
        }

        // --- NEW: Function to handle reply likes ---
        async function toggleReplyLike(replyId, replyUserId, currentLikes) {
            if (!currentUserId) {
                alert("Please log in to like a reply.");
                return;
            }

            const replyRef = db.collection('tweets').doc(tweetIdToReply).collection('replies').doc(replyId);
            const hasLiked = currentLikes.includes(currentUserId);

            try {
                if (hasLiked) {
                    // Unlike
                    await replyRef.update({
                        likes: firebase.firestore.FieldValue.arrayRemove(currentUserId)
                    });
                } else {
                    // Like
                    await replyRef.update({
                        likes: firebase.firestore.FieldValue.arrayUnion(currentUserId)
                    });

                    // Create notification for the reply author (if not self-liking)
                    if (replyUserId !== currentUserId) {
                        try {
                            const replyAuthorDoc = await db.collection('users').doc(replyUserId).get();
                            const replyAuthorUsername = replyAuthorDoc.exists ? replyAuthorDoc.data().username : 'Unknown User';

                            await db.collection('notifications').add({
                                type: 'reply_like',
                                fromUsername: currentUsername,
                                fromUserId: currentUserId,
                                toUsername: replyAuthorUsername,
                                toUserId: replyUserId,
                                tweetId: tweetIdToReply, // Original tweet ID
                                replyId: replyId, // Specific reply ID
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                read: false
                            });
                            console.log(`Reply like notification created for ${replyAuthorUsername} from ${currentUsername}`);
                        } catch (notificationError) {
                            console.error("Error creating reply like notification:", notificationError);
                        }
                    }
                }
                // Re-fetch replies to update the UI
                fetchAndDisplayReplies(tweetIdToReply);
            } catch (error) {
                console.error("Error toggling reply like:", error);
                alert("Failed to update like. Please try again.");
            }
        }

        // --- NEW: Function to handle editing a reply ---
        async function editReply(replyId, currentContent) {
            const replyCardElement = document.getElementById(`reply-${replyId}`);
            if (!replyCardElement) return;

            const contentP = replyCardElement.querySelector('.reply-content');
            const originalContent = currentContent;

            // Create a textarea for editing
            const textarea = document.createElement('textarea');
            textarea.classList.add('edit-textarea');
            textarea.value = originalContent;
            textarea.maxLength = 280; // Match tweet character limit

            // Create save and cancel buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('edit-buttons');

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.classList.add('save-btn');

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.classList.add('cancel-btn');

            buttonsDiv.appendChild(cancelBtn);
            buttonsDiv.appendChild(saveBtn);

            // Replace content with textarea and buttons
            contentP.style.display = 'none';
            replyCardElement.insertBefore(textarea, contentP.nextSibling); // Insert after original content
            replyCardElement.insertBefore(buttonsDiv, textarea.nextSibling);

            textarea.focus();

            saveBtn.addEventListener('click', async () => {
                const newContent = textarea.value.trim();
                if (!newContent) {
                    alert("Reply content cannot be empty!");
                    return;
                }
                if (newContent.length > 280) {
                    alert("Reply is too long! Max 280 characters.");
                    return;
                }

                try {
                    await db.collection('tweets').doc(tweetIdToReply).collection('replies').doc(replyId).update({
                        content: newContent,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Update timestamp on edit
                    });
                    alert("Reply updated successfully!");
                    fetchAndDisplayReplies(tweetIdToReply); // Re-fetch all replies to update UI
                } catch (error) {
                    console.error("Error updating reply:", error);
                    alert("Failed to update reply. Please try again.");
                }
            });

            cancelBtn.addEventListener('click', () => {
                // Restore original content and remove editing elements
                textarea.remove();
                buttonsDiv.remove();
                contentP.style.display = 'block';
            });
        }

        // --- NEW: Function to handle deleting a reply ---
        async function deleteReply(replyId) {
            if (!confirm("Are you sure you want to delete this reply?")) {
                return;
            }

            try {
                await db.collection('tweets').doc(tweetIdToReply).collection('replies').doc(replyId).delete();
                alert("Reply deleted successfully!");
                fetchAndDisplayReplies(tweetIdToReply); // Re-fetch all replies to update UI
            } catch (error) {
                console.error("Error deleting reply:", error);
                alert("Failed to delete reply. Please try again.");
            }
        }


        // Function to fetch and display replies
        async function fetchAndDisplayReplies(tweetId) {
            repliesLoading.style.display = 'block';
            repliesFeed.innerHTML = ''; // Clear previous replies
            noRepliesMessage.style.display = 'none';

            try {
                // Fetch replies from the subcollection, ordered by timestamp
                const repliesSnapshot = await db.collection('tweets').doc(tweetId).collection('replies').orderBy('timestamp', 'asc').get();

                if (repliesSnapshot.empty) {
                    noRepliesMessage.style.display = 'block';
                    repliesLoading.style.display = 'none';
                    return;
                }

                const replies = [];
                const userPromises = []; // To fetch user data concurrently for replies

                repliesSnapshot.forEach(doc => {
                    const reply = { id: doc.id, ...doc.data() };
                    replies.push(reply);
                    userPromises.push(db.collection('users').doc(reply.userId).get());
                });

                const userDocs = await Promise.all(userPromises);
                const usersData = {}; // Store user data by userId for quick lookup
                userDocs.forEach(userDoc => {
                    if (userDoc.exists) {
                        usersData[userDoc.id] = userDoc.data();
                    }
                });

                replies.forEach(reply => {
                    const replyCard = document.createElement('div');
                    replyCard.classList.add('reply-card');
                    replyCard.id = `reply-${reply.id}`; // Add ID for easier manipulation

                    const replyHeader = document.createElement('div');
                    replyHeader.classList.add('reply-header');

                    // --- Profile Picture / First Letter for reply author ---
                    const profilePicContainer = document.createElement('div');
                    profilePicContainer.classList.add('profile-pic-container');

                    const replyAuthorData = usersData[reply.userId];
                    if (replyAuthorData && replyAuthorData.profilePictureUrl) {
                        const profilePicImg = document.createElement('img');
                        profilePicImg.src = replyAuthorData.profilePictureUrl;
                        profilePicImg.alt = `${reply.username}'s profile picture`;
                        profilePicContainer.appendChild(profilePicImg);
                    } else {
                        const firstLetter = document.createElement('span');
                        firstLetter.textContent = reply.username ? reply.username.charAt(0).toUpperCase() : '?';
                        profilePicContainer.appendChild(firstLetter);
                    }
                    replyHeader.appendChild(profilePicContainer);

                    const usernameSpan = document.createElement('span');
                    usernameSpan.classList.add('username');
                    usernameSpan.textContent = reply.username;
                    replyHeader.appendChild(usernameSpan);

                    if (reply.isVerified) {
                        replyHeader.appendChild(createVerifiedTickSvg());
                    }

                    const contentP = document.createElement('p');
                    contentP.classList.add('reply-content');
                    contentP.textContent = reply.content;

                    const timestampSpan = document.createElement('span');
                    timestampSpan.classList.add('timestamp');
                    timestampSpan.textContent = reply.timestamp ? formatTimestamp(reply.timestamp) : 'Just now';


                    // --- NEW: Reply Actions Container (holds like and reply buttons) ---
                    const replyActionsDiv = document.createElement('div');
                    replyActionsDiv.classList.add('reply-actions');

                    // --- NEW: Like Button ---
                    const likeButton = document.createElement('div');
                    likeButton.classList.add('like-button');
                    const heartIcon = document.createElement('i');
                    const likesCount = reply.likes ? reply.likes.length : 0;
                    const hasLiked = reply.likes && reply.likes.includes(currentUserId);

                    heartIcon.classList.add('fa-heart');
                    heartIcon.classList.add(hasLiked ? 'fas' : 'far');
                    likeButton.appendChild(heartIcon);

                    const likeCountSpan = document.createElement('span');
                    likeCountSpan.classList.add('like-count');
                    likeCountSpan.textContent = likesCount > 0 ? likesCount : '';
                    likeButton.appendChild(likeCountSpan);

                    likeButton.addEventListener('click', () => {
                        toggleReplyLike(reply.id, reply.userId, reply.likes || []);
                    });
                    replyActionsDiv.appendChild(likeButton);


                    // --- "Jawab" (Reply) Button ---
                    const replyToReplyButton = document.createElement('button');
                    replyToReplyButton.textContent = 'Reply';
                    replyToReplyButton.classList.add('action-button'); // Use new class for styling

                    replyToReplyButton.addEventListener('click', () => {
                        // Tag the username of the reply's author in the input field
                        replyInput.value = `@${reply.username} ${replyInput.value}`.trim() + ' '; // Add space for easier typing
                        replyInput.focus(); // Bring focus to the input field
                    });
                    replyActionsDiv.appendChild(replyToReplyButton); // Add the "Jawab" button to actions


                    // --- NEW: Three Dots (Edit/Delete Menu) for own replies ---
                    if (currentUserId === reply.userId) {
                        const optionsMenu = document.createElement('div');
                        optionsMenu.classList.add('reply-options-menu');
                        const threeDotsIcon = document.createElement('i');
                        threeDotsIcon.classList.add('fas', 'fa-ellipsis-h');
                        optionsMenu.appendChild(threeDotsIcon);

                        const dropdownContent = document.createElement('div');
                        dropdownContent.classList.add('reply-dropdown-content');

                        const editButton = document.createElement('button');
                        editButton.textContent = 'Edit';
                        editButton.addEventListener('click', () => {
                            editReply(reply.id, reply.content);
                            dropdownContent.style.display = 'none'; // Hide menu after clicking
                        });
                        dropdownContent.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.addEventListener('click', () => {
                            deleteReply(reply.id);
                            dropdownContent.style.display = 'none'; // Hide menu after clicking
                        });
                        dropdownContent.appendChild(deleteButton);

                        optionsMenu.appendChild(dropdownContent);
                        replyCard.appendChild(optionsMenu); // Append menu to the card

                        // Toggle dropdown visibility
                        threeDotsIcon.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent card click
                            dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
                        });

                        // Hide dropdown if clicked outside
                        document.addEventListener('click', (event) => {
                            if (!optionsMenu.contains(event.target)) {
                                dropdownContent.style.display = 'none';
                            }
                        });
                    }

                    replyCard.appendChild(replyHeader);
                    replyCard.appendChild(contentP);
                    replyCard.appendChild(timestampSpan);
                    replyCard.appendChild(replyActionsDiv); // Add the actions div

                    repliesFeed.appendChild(replyCard);
                });

                repliesLoading.style.display = 'none';
            } catch (error) {
                console.error("Error fetching replies:", error);
                repliesLoading.textContent = 'Error loading replies.';
                repliesLoading.style.color = 'red';
            }
        }


        // Handle reply submission
        replyBtn.addEventListener('click', async () => {
            const replyContent = replyInput.value.trim();

            if (!replyContent) {
                alert("Reply cannot be empty!");
                return;
            }

            if (replyContent.length > 280) {
                alert("Reply is too long! Max 280 characters.");
                return;
            }

            if (!currentUserId || !currentUsername || !tweetIdToReply) {
                alert("You must be logged in and a valid tweet selected to post a reply.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Fetch the original tweet again to get its author's username/ID for notification
                const originalTweetDoc = await db.collection('tweets').doc(tweetIdToReply).get();
                if (!originalTweetDoc.exists) {
                    alert("Original tweet not found for reply.");
                    return;
                }
                const originalTweetData = originalTweetDoc.data();
                const originalTweetAuthorId = originalTweetData.userId;
                const originalTweetAuthorUsername = originalTweetData.username;


                // Add reply to a 'replies' subcollection under the original tweet
                await db.collection('tweets').doc(tweetIdToReply).collection('replies').add({
                    userId: currentUserId,
                    username: currentUsername,
                    content: replyContent,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isVerified: currentIsVerified,
                    originalTweetId: tweetIdToReply, // Redundant but good for clarity/querying
                    likes: [] // Initialize likes array
                });

                // ******************************************************
                // CREATE NOTIFICATION WHEN A USER REPLIES TO A PEEP
                // ******************************************************
                if (originalTweetAuthorId !== currentUserId) { // Don't notify if user replies to their own tweet
                    try {
                        await db.collection('notifications').add({
                            type: 'reply',
                            fromUsername: currentUsername,
                            fromUserId: currentUserId,
                            toUsername: originalTweetAuthorUsername,
                            toUserId: originalTweetAuthorId,
                            tweetId: tweetIdToReply, // Reference to the original tweet
                            tweetContent: originalTweetData.content.substring(0, 50) + (originalTweetData.content.length > 50 ? '...' : ''), // Snippet of original tweet
                            replyContent: replyContent.substring(0, 50) + (replyContent.length > 50 ? '...' : ''), // Snippet of reply
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            read: false
                        });
                        console.log(`Reply notification created for ${originalTweetAuthorUsername} from ${currentUsername}`);
                    } catch (notificationError) {
                        console.error("Error creating reply notification:", notificationError);
                    }
                }
                // ******************************************************


                alert("Reply posted successfully!");
                replyInput.value = ''; // Clear reply input
                fetchAndDisplayReplies(tweetIdToReply); // Re-fetch replies to show the new one
            } catch (error) {
                console.error("Error posting reply:", error);
                alert("Failed to post reply. Please try again.");
            }
        });

        // Check authentication state and load original tweet
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().username) {
                        const userData = userDoc.data();
                        currentUsername = userData.username;
                        currentIsVerified = userData.isVerified || false;
                    } else {
                        // Redirect if user data (username) is not found
                        window.location.href = 'index.html';
                        return;
                    }

                    tweetIdToReply = getTweetIdFromUrl();
                    if (tweetIdToReply) {
                        await fetchOriginalTweet(tweetIdToReply); // Wait for original tweet to load
                        fetchAndDisplayReplies(tweetIdToReply); // Then load replies
                    } else {
                        errorMessage.textContent = 'No tweet selected to reply to.';
                        errorMessage.style.display = 'block';
                        loadingMessage.style.display = 'none';
                        originalTweetContainer.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Error fetching user data or tweet ID:", error);
                    window.location.href = 'index.html';
                }
            } else {
                // User is signed out
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>