<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peeps Reels</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- General Body & Layout --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
        }

        /* --- Reel Navigation (Top Bar) --- */
        .reel-navigation {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            z-index: 20;
            box-sizing: border-box;
            pointer-events: auto;
        }

        .nav-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
            padding: 10px 20px;
            cursor: pointer;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            font-weight: bold;
            pointer-events: auto;
        }

        .nav-btn.active {
            color: white;
            border-bottom: 2px solid white;
        }

        .nav-btn:hover:not(.active) {
            color: rgba(255, 255, 255, 0.8);
        }

        /* --- Reels Container (Scrollable Video Feed) --- */
        .reels-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            padding-top: 50px; /* Space for the navigation bar */
            box-sizing: border-box;
        }

        /* --- Individual Reel Item --- */
        .reel-item {
            flex-shrink: 0;
            flex-grow: 1;
            width: 100%;
            min-height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            scroll-snap-align: start;
        }

        .reel-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: black;
        }

        /* --- Reel Overlay (Content on top of video) --- */
        .reel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.4) 100%);
        }

        /* --- Reel Header (Back button, Language Menu button) --- */
        .reel-header {
            display: flex;
            justify-content: space-between; /* Space out items */
            align-items: center;
            width: 100%;
            padding-bottom: 10px;
            padding-top: 10px;
            box-sizing: border-box;
            position: relative;
            z-index: 25;
        }

        .reel-header .left-section {
            display: flex;
            align-items: center;
        }

        .reel-header .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .reel-header .back-btn:hover {
            opacity: 0.8;
        }

        .reel-header .menu-btn { /* Style for the new menu button */
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            margin-left: auto; /* Push to the right */
        }

        .reel-header .menu-btn:hover {
            opacity: 0.8;
        }

        /* --- Sidebar (Like, Comment, Repost, Profile) --- */
        .reel-sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: absolute;
            right: 15px;
            bottom: 80px;
        }

        .sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
        }

        .sidebar-item i {
            font-size: 24px;
            margin-bottom: 5px;
            transition: color 0.2s ease-in-out;
        }

        .sidebar-item:hover i, .sidebar-item.liked i {
            color: #e0245e;
        }
        .sidebar-item.reposted i {
            color: #17bf63;
        }

        .sidebar-item .profile-pic-reel {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid white;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ddd;
            color: #555;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .sidebar-item .profile-pic-reel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spinning-disk {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #333;
            border: 2px solid white;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: spin 5s linear infinite;
        }

        .spinning-disk img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .spinning-disk span {
            font-size: 18px;
            color: white;
            font-weight: bold;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Content Details (Username, Description) --- */
        .reel-content-details {
            position: absolute;
            left: 15px;
            bottom: 80px;
            width: calc(100% - 150px);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .reel-username {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reel-username .verified-tick {
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-left: 0;
            flex-shrink: 0;
        }

        .follow-unfollow-btn {
            background-color: #1da1f2;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-left: 10px;
        }

        .follow-unfollow-btn:hover {
            background-color: #0d8ddb;
        }

        .follow-unfollow-btn.unfollow {
            background-color: #e0245e;
        }

        .follow-unfollow-btn.unfollow:hover {
            background-color: #c71c4c;
        }

        .follow-unfollow-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .reel-description {
            font-size: 15px;
            word-wrap: break-word;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Mute/Unmute Button --- */
        .mute-unmute-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 15;
            transition: visibility 0.5s, opacity 0.5s ease-in-out;
            opacity: 1;
        }

        .mute-unmute-btn i {
            font-size: 20px;
            color: white;
            margin: 0;
        }

        .mute-unmute-btn.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* --- Drawer Menu Styles (for global language filter) --- */
        .drawer-menu {
            position: fixed;
            top: 0;
            right: -300px; /* Hidden by default */
            width: 250px;
            height: 100%;
            background-color: #1a1a1a; /* Dark background */
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease-in-out;
            z-index: 30; /* Above everything else */
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Enable scrolling for many languages */
        }

        .drawer-menu.open {
            right: 0; /* Slide in */
        }

        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .drawer-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .drawer-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .drawer-close-btn:hover {
            opacity: 0.8;
        }

        .language-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .language-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            color: white;
            font-size: 16px;
        }

        .language-item:hover {
            background-color: #3a3a3a;
        }

        .language-item input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #bbb;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
        }

        .language-item input[type="radio"]:checked {
            border-color: #1da1f2;
            background-color: #1da1f2; /* Fill the circle when checked */
        }

        .language-item input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* --- Overlay to dim background when drawer/modal is open --- */
        .drawer-backdrop, .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 29; /* Below drawer/modal, above other content */
            display: none; /* Hidden by default */
        }
        .drawer-backdrop.active, .modal-backdrop.active {
            display: block;
        }

        /* --- No Videos Message and Button Styling --- */
        .no-videos-message {
            text-align: center;
            color: #66757f;
            margin: auto;
            padding-top: calc(50vh - 50px); /* Centers below nav bar */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; /* Ensure it takes full height of container */
            width: 100%;
        }

        .no-videos-message button {
            background-color: #1da1f2;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.2s ease;
        }

        .no-videos-message button:hover {
            background-color: #0d8ddb;
        }

        /* --- More Options Modal (for individual reel) --- */
        .more-options-modal {
            position: fixed;
            bottom: -200px; /* Hidden by default */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 300px;
            background-color: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
            transition: bottom 0.3s ease-out;
            z-index: 35; /* Above backdrop and main drawer */
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .more-options-modal.open {
            bottom: 20px; /* Slide in from bottom */
        }

        .more-options-modal button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            width: 100%;
        }

        .more-options-modal button:hover {
            background-color: #2a2a2a;
        }

        .more-options-modal button.delete-btn {
            color: #e0245e;
            font-weight: bold;
        }
        .more-options-modal button.delete-btn:hover {
            background-color: rgba(224, 36, 94, 0.1);
        }

        /* --- Reel Language Modal (for individual reel language change) --- */
        .reel-language-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 350px;
            background-color: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 40; /* Highest z-index */
            padding: 20px;
            box-sizing: border-box;
            display: none; /* Hidden by default */
            flex-direction: column;
        }

        .reel-language-modal.open {
            display: flex;
        }

        .reel-language-modal h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .reel-language-modal .language-options {
            max-height: 300px; /* Limit height for scrolling */
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .reel-language-modal .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .reel-language-modal .action-buttons button {
            background-color: #3a3a3a;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .reel-language-modal .action-buttons button:hover {
            background-color: #555;
        }

        .reel-language-modal .action-buttons button.confirm-btn {
            background-color: #1da1f2;
        }
        .reel-language-modal .action-buttons button.confirm-btn:hover {
            background-color: #0d8ddb;
        }


        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 600px) {
            .reel-overlay {
                padding: 10px;
            }
            .reel-sidebar {
                right: 5px;
                bottom: 70px;
                gap: 15px;
            }
            .sidebar-item i {
                font-size: 20px;
            }
            .sidebar-item .profile-pic-reel {
                width: 40px;
                height: 40px;
            }
            .spinning-disk {
                width: 40px;
                height: 40px;
            }
            .spinning-disk span {
                font-size: 16px;
            }
            .mute-unmute-btn {
                width: 35px;
                height: 35px;
                bottom: 15px;
                left: 15px;
            }
            .mute-unmute-btn i {
                font-size: 18px;
            }
            .reel-content-details {
                left: 10px;
                bottom: 70px;
                width: calc(100% - 100px);
            }
            .reel-username {
                font-size: 14px;
            }
            .reel-description {
                font-size: 14px;
            }
            .reel-navigation {
                padding: 8px 0;
            }
            .nav-btn {
                font-size: 15px;
                padding: 8px 15px;
            }
            .reels-container {
                padding-top: 45px;
            }
            .reel-header {
                padding-top: 5px;
            }
            .drawer-menu {
                width: 200px; /* Smaller width for mobile */
            }
            .no-videos-message {
                padding-top: calc(50vh - 45px);
            }
            .more-options-modal {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="reel-navigation">
        <button class="nav-btn active" id="forYouBtn">For You</button>
        <button class="nav-btn" id="followingBtn">Following</button>
    </div>

    <div class="reels-container" id="reels-container">
    </div>

    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <div class="drawer-menu" id="drawerMenu">
        <div class="drawer-header">
            <h3>Filter by Language</h3>
            <button class="drawer-close-btn" id="drawerCloseBtn"><i class="fas fa-times"></i></button>
        </div>
        <div class="language-options" id="languageOptions">
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="all" checked>
                <span>All Languages</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="english">
                <span>English</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="hindi">
                <span>Hindi</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="punjabi">
                <span>Punjabi</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="gujarati">
                <span>Gujarati</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="bengali">
                <span>Bengali</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="tamil">
                <span>Tamil</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="telugu">
                <span>Telugu</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="kannada">
                <span>Kannada</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="malayalam">
                <span>Malayalam</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="marathi">
                <span>Marathi</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="urdu">
                <span>Urdu</span>
            </label>
            <label class="language-item">
                <input type="radio" name="videoLanguage" value="other">
                <span>Other</span>
            </label>
        </div>
    </div>

    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="more-options-modal" id="moreOptionsModal">
        <button id="changeReelLanguageBtn">Change Reel Language</button>
        <button class="delete-btn" id="deleteReelBtn">Delete Reel</button>
        <button id="cancelModalBtn">Cancel</button>
    </div>

    <div class="reel-language-modal" id="reelLanguageModal">
        <h3>Change Reel Language</h3>
        <div class="language-options" id="reelLanguageOptions">
            </div>
        <div class="action-buttons">
            <button id="cancelReelLanguageBtn">Cancel</button>
            <button class="confirm-btn" id="confirmReelLanguageBtn">Update Language</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <script>
        // Your Firebase configuration (same as home.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBh9gNTXJYgcvt4vuiV5U0UqSeFhH8afcA",
            authDomain: "yellowchat-ad31a.firebaseapp.com",
            databaseURL: "https://yellowchat-ad31a-default-rtdb.firebaseio.com",
            projectId: "yellowchat-ad31a",
            storageBucket: "yellowchat-ad31a.firebasestorage.app",
            messagingSenderId: "592543476537",
            appId: "1:592543476537:web:10a2102227c06ac0d756e8",
            measurementId: "G-2BZFXPKCHD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize storage

        const reelsContainer = document.getElementById('reels-container');
        const forYouBtn = document.getElementById('forYouBtn');
        const followingBtn = document.getElementById('followingBtn');
        const drawerMenu = document.getElementById('drawerMenu');
        const drawerCloseBtn = document.getElementById('drawerCloseBtn');
        const drawerBackdrop = document.getElementById('drawerBackdrop');
        const languageOptions = document.getElementById('languageOptions');

        const modalBackdrop = document.getElementById('modalBackdrop');
        const moreOptionsModal = document.getElementById('moreOptionsModal');
        const deleteReelBtn = document.getElementById('deleteReelBtn');
        const changeReelLanguageBtn = document.getElementById('changeReelLanguageBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');

        const reelLanguageModal = document.getElementById('reelLanguageModal');
        const reelLanguageOptions = document.getElementById('reelLanguageOptions');
        const cancelReelLanguageBtn = document.getElementById('cancelReelLanguageBtn');
        const confirmReelLanguageBtn = document.getElementById('confirmReelLanguageBtn');

        let currentUserId = null;
        let currentUsername = null;
        let following = new Set();
        let isMutedGlobally = true;
        let currentView = 'forYou';
        let currentReelForEdit = null; // Stores the tweet object of the reel being edited

        // Retrieve selected language from localStorage or default to 'all'
        let selectedLanguage = localStorage.getItem('selectedVideoLanguage') || 'all';

        // All available languages (for both filter and reel editing)
        const ALL_LANGUAGES = [
            { value: 'all', label: 'All Languages' },
            { value: 'english', label: 'English' },
            { value: 'hindi', label: 'Hindi' },
            { value: 'punjabi', label: 'Punjabi' },
            { value: 'gujarati', label: 'Gujarati' },
            { value: 'bengali', label: 'Bengali' },
            { value: 'tamil', label: 'Tamil' },
            { value: 'telugu', label: 'Telugu' },
            { value: 'kannada', label: 'Kannada' },
            { value: 'malayalam', label: 'Malayalam' },
            { value: 'marathi', label: 'Marathi' },
            { value: 'urdu', label: 'Urdu' },
            { value: 'other', label: 'Other' }
        ];

        // Function to create the verified tick SVG element (reused from home.html)
        function createVerifiedTickSvg() {
            const svgString = `<svg class="verified-tick" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="256" height="256" viewBox="0 0 256 256" xml:space="preserve">
<g style="stroke: none; stroke-width: 0; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: none; fill-rule: nonzero; opacity: 1;" transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
	<polygon points="45,6.18 57.06,0 64.41,11.38 77.94,12.06 78.62,25.59 90,32.94 83.82,45 90,57.06 78.62,64.41 77.94,77.94 64.41,78.62 57.06,90 45,83.82 32.94,90 25.59,78.62 12.06,77.94 11.38,64.41 0,57.06 6.18,45 0,32.94 11.38,25.59 12.06,12.06 25.59,11.38 32.94,0 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(0,150,241); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
	<polygon points="40.16,58.47 26.24,45.08 29.7,41.48 40.15,51.52 61.22,31.08 64.7,34.67 " style="stroke: none; stroke-width: 1; stroke-dasharray: none; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 10; fill: rgb(255,255,255); fill-rule: nonzero; opacity: 1;" transform="  matrix(1 0 0 1 0 0) "/>
</g>
</svg>`;
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
            return svgDoc.documentElement;
        }

        // Function to fetch current user's following list (reused from home.html)
        async function fetchFollowingList(userId) {
            if (!userId) return;
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    following = new Set(userData.following || []);
                } else {
                    following = new Set();
                }
            } catch (error) {
                console.error("Error fetching following list:", error);
            }
        }

        // Function to handle follow/unfollow action (reused from home.html, adapted for current context)
        async function toggleFollow(targetUsername, targetUserId, buttonElement) {
            if (!currentUserId || !currentUsername) {
                alert("You must be logged in to follow/unfollow users.");
                window.location.href = 'index.html';
                return;
            }

            if (targetUsername === currentUsername) {
                alert("You cannot follow or unfollow yourself.");
                return;
            }

            const userRef = db.collection('users').doc(currentUserId);
            const targetUserRef = db.collection('users').doc(targetUserId);

            try {
                if (following.has(targetUsername)) {
                    await userRef.update({ following: firebase.firestore.FieldValue.arrayRemove(targetUsername) });
                    await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayRemove(currentUsername) });
                    following.delete(targetUsername);
                    buttonElement.textContent = 'Follow';
                    buttonElement.classList.remove('unfollow');
                } else {
                    await userRef.update({ following: firebase.firestore.FieldValue.arrayUnion(targetUsername) });
                    await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayUnion(currentUsername) });
                    following.add(targetUsername);
                    buttonElement.textContent = 'Unfollow';
                    buttonElement.classList.add('unfollow');

                    try {
                        const existingNotificationQuery = await db.collection('notifications')
                            .where('type', '==', 'follow')
                            .where('fromUserId', '==', currentUserId)
                            .where('toUserId', '==', targetUserId)
                            .limit(1)
                            .get();

                        if (!existingNotificationQuery.empty) {
                            const existingNotificationDoc = existingNotificationQuery.docs[0];
                            await existingNotificationDoc.ref.update({
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                read: false,
                                actionTaken: false
                            });
                        } else {
                            await db.collection('notifications').add({
                                type: 'follow',
                                fromUsername: currentUsername,
                                fromUserId: currentUserId,
                                toUsername: targetUsername,
                                toUserId: targetUserId,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                read: false,
                                actionTaken: false
                            });
                        }
                    } catch (notificationError) {
                        console.error("Error handling follow notification:", notificationError);
                    }
                }
            } catch (error) {
                console.error("Error toggling follow status:", error);
                alert("Failed to update follow status. Please try again.");
            }
        }

        // Object to cache user data to avoid redundant fetches
        const usersCache = {};

        // Function to create a single reel item
        async function createReelItem(tweet, tweetAuthorData) {
            if (!tweet.videoUrl) return null;

            const reelItem = document.createElement('div');
            reelItem.classList.add('reel-item');
            reelItem.dataset.tweetId = tweet.id;

            const video = document.createElement('video');
            video.classList.add('reel-video');
            video.src = tweet.videoUrl;
            video.loop = true;
            video.muted = isMutedGlobally;
            video.playsInline = true;
            video.preload = "metadata";

            const overlay = document.createElement('div');
            overlay.classList.add('reel-overlay');

            // Header (Back button and new Menu button)
            const reelHeader = document.createElement('div');
            reelHeader.classList.add('reel-header');

            const leftHeaderSection = document.createElement('div');
            leftHeaderSection.classList.add('left-section');

            const backButton = document.createElement('button');
            backButton.classList.add('back-btn');
            backButton.innerHTML = '<i class="fas fa-arrow-left"></i>';
            backButton.addEventListener('click', () => window.history.back());
            leftHeaderSection.appendChild(backButton);
            reelHeader.appendChild(leftHeaderSection);

            // New Menu Button (for global language selection filter)
            const menuButton = document.createElement('button');
            menuButton.classList.add('menu-btn');
            menuButton.innerHTML = '<i class="fas fa-bars"></i>'; // Hamburger icon
            menuButton.addEventListener('click', () => {
                drawerMenu.classList.add('open');
                drawerBackdrop.classList.add('active');
            });
            reelHeader.appendChild(menuButton);

            overlay.appendChild(reelHeader);

            // Mute/Unmute Button
            const muteUnmuteButton = document.createElement('div');
            muteUnmuteButton.classList.add('mute-unmute-btn');
            const muteUnmuteIcon = document.createElement('i');
            muteUnmuteIcon.classList.add('fas', isMutedGlobally ? 'fa-volume-mute' : 'fa-volume-up');
            muteUnmuteButton.appendChild(muteUnmuteIcon);

            if (!isMutedGlobally) {
                muteUnmuteButton.classList.add('hidden');
            }

            muteUnmuteButton.addEventListener('click', () => {
                isMutedGlobally = !isMutedGlobally;
                if (isMutedGlobally) {
                    muteUnmuteIcon.classList.replace('fa-volume-up', 'fa-volume-mute');
                    muteUnmuteButton.classList.remove('hidden');
                } else {
                    muteUnmuteIcon.classList.replace('fa-volume-mute', 'fa-volume-up');
                    muteUnmuteButton.classList.add('hidden');
                }

                document.querySelectorAll('.reel-video').forEach(vid => {
                    vid.muted = isMutedGlobally;
                });

                if (currentlyPlayingVideo) {
                    currentlyPlayingVideo.muted = isMutedGlobally;
                }
            });
            overlay.appendChild(muteUnmuteButton);

            // Sidebar (Profile, Like, Comment, Repost, More, Spinning Disk)
            const reelSidebar = document.createElement('div');
            reelSidebar.classList.add('reel-sidebar');

            // Profile Picture
            const profilePicItem = document.createElement('a');
            profilePicItem.classList.add('sidebar-item');
            profilePicItem.href = `user_profile.html?username=${encodeURIComponent(tweet.username)}`;
            const profilePicContainer = document.createElement('div');
            profilePicContainer.classList.add('profile-pic-reel');
            if (tweetAuthorData && tweetAuthorData.profilePictureUrl) {
                const profilePicImg = document.createElement('img');
                profilePicImg.src = tweetAuthorData.profilePictureUrl;
                profilePicImg.alt = `${tweet.username}'s profile picture`;
                profilePicContainer.appendChild(profilePicImg);
            } else {
                const firstLetter = document.createElement('span');
                firstLetter.textContent = tweet.username ? tweet.username.charAt(0).toUpperCase() : '?';
                profilePicContainer.appendChild(firstLetter);
            }
            profilePicItem.appendChild(profilePicContainer);
            reelSidebar.appendChild(profilePicItem);


            // Like Button
            const likeItem = document.createElement('div');
            likeItem.classList.add('sidebar-item', 'like-btn');
            likeItem.innerHTML = `<i class="far fa-heart"></i> <span class="like-count">${tweet.likes ? tweet.likes.length : 0}</span>`;
            if (currentUserId && (tweet.likes || []).includes(currentUserId)) {
                likeItem.classList.add('liked');
                likeItem.querySelector('i').classList.replace('far', 'fas');
            }
            likeItem.addEventListener('click', async () => {
                if (!currentUserId) {
                    alert("You must be logged in to like videos.");
                    window.location.href = 'index.html';
                    return;
                }
                const tweetRef = db.collection('tweets').doc(tweet.id);
                const currentLikes = new Set(tweet.likes || []);
                try {
                    if (currentLikes.has(currentUserId)) {
                        await tweetRef.update({ likes: firebase.firestore.FieldValue.arrayRemove(currentUserId) });
                        currentLikes.delete(currentUserId);
                        likeItem.classList.remove('liked');
                        likeItem.querySelector('i').classList.replace('fas', 'far');
                    } else {
                        await tweetRef.update({ likes: firebase.firestore.FieldValue.arrayUnion(currentUserId) });
                        currentLikes.add(currentUserId);
                        likeItem.classList.add('liked');
                        likeItem.querySelector('i').classList.replace('far', 'fas');
                        if (tweet.userId !== currentUserId) {
                            try {
                                await db.collection('notifications').add({
                                    type: 'like',
                                    fromUsername: currentUsername,
                                    fromUserId: currentUserId,
                                    toUsername: tweet.username,
                                    toUserId: tweet.userId,
                                    tweetId: tweet.id,
                                    tweetContent: tweet.content ? tweet.content.substring(0, 50) + (tweet.content.length > 50 ? '...' : '') : 'Video',
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false
                                });
                            } catch (e) { console.error("Error creating like notification:", e); }
                        }
                    }
                    likeItem.querySelector('.like-count').textContent = currentLikes.size;
                    tweet.likes = Array.from(currentLikes);
                } catch (error) { console.error("Error updating like status:", error); }
            });
            reelSidebar.appendChild(likeItem);

            // Comment Button (without reply count)
            const commentItem = document.createElement('a');
            commentItem.classList.add('sidebar-item', 'comment-btn');
            commentItem.href = `reply.html?tweetId=${tweet.id}`;
            commentItem.innerHTML = `<i class="far fa-comment"></i>`;
            reelSidebar.appendChild(commentItem);

            // Repost Button
            const repostItem = document.createElement('div');
            repostItem.classList.add('sidebar-item', 'repost-btn');
            repostItem.innerHTML = `<i class="fas fa-retweet"></i> <span class="repost-count">${tweet.reposts ? tweet.reposts.length : 0}</span>`;
            if (currentUserId && (tweet.reposts || []).includes(currentUserId)) {
                repostItem.classList.add('reposted');
            }
            repostItem.addEventListener('click', async () => {
                if (!currentUserId) {
                    alert("You must be logged in to repost videos.");
                    window.location.href = 'index.html';
                    return;
                }
                const tweetRef = db.collection('tweets').doc(tweet.id);
                const currentReposts = new Set(tweet.reposts || []);
                try {
                    if (currentReposts.has(currentUserId)) {
                        await tweetRef.update({ reposts: firebase.firestore.FieldValue.arrayRemove(currentUserId) });
                        currentReposts.delete(currentUserId);
                        repostItem.classList.remove('reposted');
                    } else {
                        await tweetRef.update({ reposts: firebase.firestore.FieldValue.arrayUnion(currentUserId) });
                        currentReposts.add(currentUserId);
                        repostItem.classList.add('reposted');
                        if (tweet.userId !== currentUserId) {
                            try {
                                await db.collection('notifications').add({
                                    type: 'repost',
                                    fromUsername: currentUsername,
                                    fromUserId: currentUserId,
                                    toUsername: tweet.username,
                                    toUserId: tweet.userId,
                                    tweetId: tweet.id,
                                    tweetContent: tweet.content ? tweet.content.substring(0, 50) + (tweet.content.length > 50 ? '...' : '') : 'Video',
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                    read: false
                                });
                            } catch (e) { console.error("Error creating repost notification:", e); }
                        }
                    }
                    repostItem.querySelector('.repost-count').textContent = currentReposts.size;
                    tweet.reposts = Array.from(currentReposts);
                } catch (error) { console.error("Error updating repost status:", error); }
            });
            reelSidebar.appendChild(repostItem);


            // More (Three Dots) - This is where the magic happens for owner-specific actions
            const moreItem = document.createElement('div');
            moreItem.classList.add('sidebar-item');
            moreItem.innerHTML = '<i class="fas fa-ellipsis-h"></i>';
            moreItem.addEventListener('click', () => {
                if (currentUserId && tweet.userId === currentUserId) {
                    // It's the current user's reel, show specific options
                    currentReelForEdit = tweet; // Store the reel data
                    moreOptionsModal.classList.add('open');
                    modalBackdrop.classList.add('active');
                } else {
                    // Default options for other users' reels (or just an alert for now)
                    alert('More options for this video (reporting, sharing, etc. - not yet implemented)');
                }
            });
            reelSidebar.appendChild(moreItem);

            // Spinning Disk (Music Icon or Placeholder with Profile Pic)
            const spinningDisk = document.createElement('div');
            spinningDisk.classList.add('spinning-disk');
            if (tweetAuthorData && tweetAuthorData.profilePictureUrl) {
                const diskImg = document.createElement('img');
                diskImg.src = tweetAuthorData.profilePictureUrl;
                diskImg.alt = `${tweet.username}'s profile picture`;
                spinningDisk.appendChild(diskImg);
            } else {
                const firstLetter = document.createElement('span');
                firstLetter.textContent = tweet.username ? tweet.username.charAt(0).toUpperCase() : '?';
                spinningDisk.appendChild(firstLetter);
            }
            reelSidebar.appendChild(spinningDisk);

            overlay.appendChild(reelSidebar);

            // Content Details (Username, Description)
            const contentDetails = document.createElement('div');
            contentDetails.classList.add('reel-content-details');

            const usernameLine = document.createElement('div');
            usernameLine.classList.add('reel-username');

            const usernameLink = document.createElement('a');
            usernameLink.href = `user_profile.html?username=${encodeURIComponent(tweet.username)}`;
            usernameLink.style.color = 'inherit';
            usernameLink.style.textDecoration = 'none';
            usernameLink.style.fontWeight = 'bold';
            usernameLink.textContent = `@${tweet.username}`;

            usernameLine.appendChild(usernameLink);

            if (tweetAuthorData && tweetAuthorData.isVerified) {
                usernameLine.appendChild(createVerifiedTickSvg());
            }

            // Follow/Unfollow Button
            const followButton = document.createElement('button');
            followButton.classList.add('follow-unfollow-btn');
            followButton.dataset.username = tweet.username;
            followButton.dataset.userId = tweet.userId;

            if (currentUsername && tweet.username === currentUsername) {
                followButton.textContent = 'You';
                followButton.disabled = true;
            } else if (following.has(tweet.username)) {
                followButton.textContent = 'Unfollow';
                followButton.classList.add('unfollow');
            } else {
                followButton.textContent = 'Follow';
            }

            followButton.addEventListener('click', () => {
                toggleFollow(tweet.username, tweet.userId, followButton);
            });
            usernameLine.appendChild(followButton);

            contentDetails.appendChild(usernameLine);

            if (tweet.content) {
                const descriptionP = document.createElement('p');
                descriptionP.classList.add('reel-description');
                descriptionP.textContent = tweet.content;
                contentDetails.appendChild(descriptionP);
            }

            overlay.appendChild(contentDetails);

            reelItem.appendChild(video);
            reelItem.appendChild(overlay);

            return reelItem;
        }

        // --- Intersection Observer for Video Autoplay ---
        const videoObserverOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.7
        };

        let currentlyPlayingVideo = null;

        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                const muteButton = video.closest('.reel-item').querySelector('.mute-unmute-btn');

                if (entry.isIntersecting) {
                    if (currentlyPlayingVideo && currentlyPlayingVideo !== video) {
                        currentlyPlayingVideo.pause();
                        currentlyPlayingVideo.currentTime = 0;
                        const prevMuteButton = currentlyPlayingVideo.closest('.reel-item').querySelector('.mute-unmute-btn');
                        if (prevMuteButton) {
                            prevMuteButton.classList.remove('hidden');
                        }
                    }
                    video.muted = isMutedGlobally;
                    video.play().catch(error => {
                        console.warn("Video autoplay prevented:", error);
                    });
                    currentlyPlayingVideo = video;

                    if (muteButton) {
                        if (isMutedGlobally) {
                            muteButton.classList.remove('hidden');
                        } else {
                            muteButton.classList.add('hidden');
                        }
                    }

                } else {
                    if (video === currentlyPlayingVideo) {
                        video.pause();
                        video.currentTime = 0;
                        currentlyPlayingVideo = null;
                        if (muteButton) {
                            muteButton.classList.remove('hidden');
                        }
                    }
                }
            });
        }, videoObserverOptions);

        // Function to fetch and display videos (reels) based on view and selected language
        async function fetchAndDisplayReels(view) {
            // Stop and reset current video before loading new ones
            if (currentlyPlayingVideo) {
                currentlyPlayingVideo.pause();
                currentlyPlayingVideo.currentTime = 0;
                currentlyPlayingVideo = null;
            }
            // Clear existing reels and display loading message
            reelsContainer.innerHTML = '<div class="no-videos-message">Loading videos...</div>';
            
            // Unobserve all videos before clearing the container to prevent errors
            reelsContainer.querySelectorAll('.reel-video').forEach(video => {
                videoObserver.unobserve(video);
            });

            try {
                const tweetsSnapshot = await db.collection('tweets').get();
                let videoTweets = [];
                const userPromises = [];

                tweetsSnapshot.forEach(doc => {
                    const tweet = { id: doc.id, ...doc.data() };
                    if (tweet.videoUrl) {
                        const meetsLanguageCriteria = (selectedLanguage === 'all' || (tweet.videoLanguage && tweet.videoLanguage.toLowerCase() === selectedLanguage));

                        if (meetsLanguageCriteria) {
                            if (view === 'forYou') {
                                videoTweets.push(tweet);
                            } else if (view === 'following' && currentUsername && following.has(tweet.username)) {
                                videoTweets.push(tweet);
                            }
                        }

                        // Collect unique user IDs to fetch their data efficiently
                        if (!usersCache[tweet.userId]) {
                            userPromises.push(db.collection('users').doc(tweet.userId).get());
                        }
                    }
                });

                if (videoTweets.length === 0) {
                    let message = 'No videos found.';
                    if (view === 'following') {
                        message = 'No videos from users you follow. Follow more people to see their reels here!';
                    } else if (selectedLanguage !== 'all') {
                        message = `No videos found for '${selectedLanguage}' language. Try another language or "All Languages".`;
                    } else {
                        message = 'No videos found. Be the first to share a video!';
                    }
                    
                    reelsContainer.innerHTML = `
                        <div class="no-videos-message">
                            <p>${message}</p>
                            ${selectedLanguage !== 'all' ? '<button id="changeLanguageBtn">Change Language</button>' : ''}
                        </div>
                    `;

                    // Add event listener for the new button if it exists
                    const changeLanguageBtn = document.getElementById('changeLanguageBtn');
                    if (changeLanguageBtn) {
                        changeLanguageBtn.addEventListener('click', () => {
                            drawerMenu.classList.add('open');
                            drawerBackdrop.classList.add('active');
                        });
                    }
                    return;
                }

                // Fetch all unique user data
                const userDocs = await Promise.all(userPromises);
                userDocs.forEach(userDoc => {
                    if (userDoc.exists) {
                        usersCache[userDoc.id] = userDoc.data();
                    }
                });

                shuffleArray(videoTweets);

                reelsContainer.innerHTML = ''; // Clear loading message

                for (const tweet of videoTweets) {
                    const tweetAuthorData = usersCache[tweet.userId] || null;
                    const reelItem = await createReelItem(tweet, tweetAuthorData);
                    if (reelItem) {
                        reelsContainer.appendChild(reelItem);
                        const videoElement = reelItem.querySelector('.reel-video');
                        if (videoElement) {
                            videoObserver.observe(videoElement);
                        }
                    }
                }

                // Autoplay the first video after loading
                setTimeout(() => {
                    reelsContainer.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    if (reelsContainer.children.length > 0) {
                        const firstVideo = reelsContainer.querySelector('.reel-video');
                        const firstMuteButton = reelsContainer.querySelector('.mute-unmute-btn');

                        if (firstVideo) {
                            firstVideo.muted = isMutedGlobally;
                            firstVideo.play().catch(error => {
                                console.warn("Initial autoplay prevented:", error);
                            });
                            currentlyPlayingVideo = firstVideo;

                            if (firstMuteButton) {
                                if (isMutedGlobally) {
                                    firstMuteButton.classList.remove('hidden');
                                } else {
                                    firstMuteButton.classList.add('hidden');
                                }
                            }
                        }
                    }
                }, 100);

            } catch (error) {
                console.error("Error fetching video tweets:", error);
                reelsContainer.innerHTML = `
                    <div class="no-videos-message">
                        <p style="color: red;">Error loading videos. Please try again.</p>
                        <button id="changeLanguageBtn">Change Language</button>
                    </div>
                `;
                // Add event listener for the new button on error
                const changeLanguageBtn = document.getElementById('changeLanguageBtn');
                if (changeLanguageBtn) {
                    changeLanguageBtn.addEventListener('click', () => {
                        drawerMenu.classList.add('open');
                        drawerBackdrop.classList.add('active');
                    });
                }
            }
        }

        // Shuffle array helper
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Function to update the radio button state in the main language filter drawer
        function updateMainLanguageRadio() {
            const radioButtons = languageOptions.querySelectorAll('input[name="videoLanguage"]');
            radioButtons.forEach(radio => {
                if (radio.value === selectedLanguage) {
                    radio.checked = true;
                } else {
                    radio.checked = false;
                }
            });
        }

        // Function to populate and update the reel-specific language modal
        function populateReelLanguageModal(currentReelLanguage) {
            reelLanguageOptions.innerHTML = ''; // Clear previous options
            ALL_LANGUAGES.filter(lang => lang.value !== 'all').forEach(lang => { // Exclude 'All Languages' for single reel
                const label = document.createElement('label');
                label.classList.add('language-item');
                label.innerHTML = `
                    <input type="radio" name="reelSpecificLanguage" value="${lang.value}" ${lang.value === currentReelLanguage ? 'checked' : ''}>
                    <span>${lang.label}</span>
                `;
                reelLanguageOptions.appendChild(label);
            });
        }

        // --- Event Listeners ---

        // Navigation buttons
        forYouBtn.addEventListener('click', () => {
            if (currentView !== 'forYou') {
                currentView = 'forYou';
                forYouBtn.classList.add('active');
                followingBtn.classList.remove('active');
                fetchAndDisplayReels(currentView);
            }
        });

        followingBtn.addEventListener('click', () => {
            if (currentView !== 'following') {
                currentView = 'following';
                forYouBtn.classList.remove('active');
                followingBtn.classList.add('active');
                fetchAndDisplayReels(currentView);
            }
        });

        // Main Language Filter Drawer
        drawerCloseBtn.addEventListener('click', () => {
            drawerMenu.classList.remove('open');
            drawerBackdrop.classList.remove('active');
        });

        drawerBackdrop.addEventListener('click', () => {
            drawerMenu.classList.remove('open');
            drawerBackdrop.classList.remove('active');
        });

        languageOptions.addEventListener('change', (event) => {
            if (event.target.name === 'videoLanguage') {
                selectedLanguage = event.target.value;
                // Save the selected language to localStorage
                localStorage.setItem('selectedVideoLanguage', selectedLanguage);
                console.log("Selected language saved:", selectedLanguage);
                drawerMenu.classList.remove('open');
                drawerBackdrop.classList.remove('active');
                fetchAndDisplayReels(currentView); // Re-fetch reels with new language filter
            }
        });

        // More Options Modal (Delete/Change Language)
        cancelModalBtn.addEventListener('click', () => {
            moreOptionsModal.classList.remove('open');
            modalBackdrop.classList.remove('active');
            currentReelForEdit = null; // Clear the stored reel
        });

        modalBackdrop.addEventListener('click', () => {
            // Close all modals/drawers when backdrop is clicked
            moreOptionsModal.classList.remove('open');
            reelLanguageModal.classList.remove('open');
            drawerMenu.classList.remove('open');
            modalBackdrop.classList.remove('active');
            drawerBackdrop.classList.remove('active'); // Ensure main drawer backdrop closes too
            currentReelForEdit = null;
        });

        deleteReelBtn.addEventListener('click', async () => {
            if (!currentReelForEdit || !currentUserId || currentReelForEdit.userId !== currentUserId) {
                alert("Error: Cannot delete this reel.");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to permanently delete this reel? This action cannot be undone.");

            if (confirmDelete) {
                try {
                    // 1. Delete video from Firebase Storage
                    if (currentReelForEdit.videoUrl) {
                        const videoRef = storage.refFromURL(currentReelForEdit.videoUrl);
                        await videoRef.delete();
                        console.log("Video deleted from storage:", currentReelForEdit.videoUrl);
                    }

                    // 2. Delete tweet document from Firestore
                    await db.collection('tweets').doc(currentReelForEdit.id).delete();
                    console.log("Reel document deleted:", currentReelForEdit.id);

                    // 3. Delete related notifications
                    const notificationsRef = db.collection('notifications');
                    const relatedNotificationsSnapshot = await notificationsRef
                        .where('tweetId', '==', currentReelForEdit.id)
                        .get();

                    const batch = db.batch();
                    relatedNotificationsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    console.log("Related notifications deleted for tweet:", currentReelForEdit.id);

                    alert("Reel deleted successfully!");
                    moreOptionsModal.classList.remove('open');
                    modalBackdrop.classList.remove('active');
                    currentReelForEdit = null; // Clear the stored reel
                    fetchAndDisplayReels(currentView); // Refresh reels after deletion
                } catch (error) {
                    console.error("Error deleting reel:", error);
                    alert("Failed to delete reel. Please try again.");
                }
            }
        });

        changeReelLanguageBtn.addEventListener('click', () => {
            if (!currentReelForEdit) {
                alert("No reel selected for language change.");
                return;
            }
            moreOptionsModal.classList.remove('open'); // Close the initial options modal
            populateReelLanguageModal(currentReelForEdit.videoLanguage || 'all'); // Populate and pre-select
            reelLanguageModal.classList.add('open'); // Open the language selection modal
            modalBackdrop.classList.add('active'); // Ensure backdrop is active
        });

        // Reel Language Selection Modal
        cancelReelLanguageBtn.addEventListener('click', () => {
            reelLanguageModal.classList.remove('open');
            modalBackdrop.classList.remove('active');
            currentReelForEdit = null; // Clear the stored reel
        });

        confirmReelLanguageBtn.addEventListener('click', async () => {
            if (!currentReelForEdit || !currentUserId || currentReelForEdit.userId !== currentUserId) {
                alert("Error: Cannot update language for this reel.");
                return;
            }

            const selectedRadio = reelLanguageOptions.querySelector('input[name="reelSpecificLanguage"]:checked');
            if (!selectedRadio) {
                alert("Please select a language.");
                return;
            }

            const newLanguage = selectedRadio.value;

            try {
                const tweetRef = db.collection('tweets').doc(currentReelForEdit.id);
                await tweetRef.update({ videoLanguage: newLanguage });
                console.log(`Reel ${currentReelForEdit.id} language updated to: ${newLanguage}`);
                alert(`Reel language updated to '${newLanguage.charAt(0).toUpperCase() + newLanguage.slice(1)}' successfully!`);

                reelLanguageModal.classList.remove('open');
                modalBackdrop.classList.remove('active');
                currentReelForEdit = null; // Clear the stored reel
                fetchAndDisplayReels(currentView); // Refresh reels after language change
            } catch (error) {
                console.error("Error updating reel language:", error);
                alert("Failed to update reel language. Please try again.");
            }
        });

        // Check authentication state on page load
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().username) {
                        currentUsername = userDoc.data().username;
                        await fetchFollowingList(currentUserId);
                        // Update the UI for the selected language on load
                        updateMainLanguageRadio();
                        fetchAndDisplayReels(currentView);
                    } else {
                        // Redirect to index.html if user data is incomplete
                        window.location.href = 'index.html';
                    }
                } catch (error) {
                    console.error("Error fetching current user data:", error);
                    // Redirect to index.html on error fetching user data
                    window.location.href = 'index.html';
                }
            } else {
                // Redirect to index.html if not logged in
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
